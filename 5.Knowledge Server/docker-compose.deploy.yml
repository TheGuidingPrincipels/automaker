# Docker Compose for Deployment
# Extends the base docker-compose.yml with the MCP server service
# Usage: docker-compose -f docker-compose.yml -f docker-compose.deploy.yml up -d

version: '3.8'

services:
  # MCP Knowledge Server Application
  mcp-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mcp-knowledge-server
    depends_on:
      neo4j:
        condition: service_healthy
    environment:
      # Neo4j Configuration
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-password}

      # ChromaDB Configuration
      - CHROMA_PERSIST_DIRECTORY=/app/data/chromadb

      # Event Store
      - EVENT_STORE_PATH=/app/data/events/events.db

      # Embedding Model
      - EMBEDDING_MODEL=sentence-transformers/all-MiniLM-L6-v2
      - EMBEDDING_CACHE_DIR=/app/data/embeddings

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - MCP_SERVER_NAME=knowledge-server

    volumes:
      # Persist data
      - mcp_data:/app/data
      - mcp_logs:/app/logs

    networks:
      - mcp-network

    restart: unless-stopped

    # Uncomment if your server exposes HTTP/gRPC ports
    # ports:
    #   - "8000:8000"

    healthcheck:
      test: ['CMD', 'python', '-c', 'import sys; sys.exit(0)']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  # MCP Server data volumes
  mcp_data:
    driver: local
  mcp_logs:
    driver: local

# Note: This file extends docker-compose.yml
# Networks and Neo4j service are defined in the base docker-compose.yml
