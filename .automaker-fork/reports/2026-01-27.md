# Upstream Changes Report - 2026-01-27

## Summary

- **Period**: 2026-01-24 to 2026-01-27
- **Upstream Branch**: `upstream/v0.14.0rc` (active development)
- **Our Previous Baseline**: `900bbb5e`
- **Current Upstream HEAD**: `cf35ca86`
- **Total New Commits**: 30 (excluding merges: ~50 with merge commits)
- **Commits in Watch Paths**: 34
- **Conflict Severity**: **HIGH**

### Branch Status

| Branch                                     | New Commits | Status                 |
| ------------------------------------------ | ----------- | ---------------------- |
| `upstream/main`                            | 0           | No changes             |
| `upstream/v0.14.0rc`                       | 30+         | **Active development** |
| `upstream/feat/coderabbit-cli-integration` | New         | Feature branch         |
| `upstream/refactor/store-ui-slice`         | New         | Refactor branch        |

---

## Conflict Analysis

**Severity**: HIGH

### Merge Simulation Result

- Clean merge possible: **No**
- Conflicting files: **9**

### Conflicting Files

| File                                                                     | Watch Path? | Impact   | Conflict Type |
| ------------------------------------------------------------------------ | ----------- | -------- | ------------- |
| `apps/server/src/index.ts`                                               | Yes         | Low      | Content       |
| `apps/server/src/routes/setup/common.ts`                                 | Yes         | Low      | Content       |
| `apps/server/src/services/auto-mode-service.ts`                          | Yes         | **High** | Content       |
| `apps/ui/eslint.config.mjs`                                              | No          | Minimal  | Content       |
| `apps/ui/src/components/views/setup-view/steps/claude-setup-step.tsx`    | Yes         | Medium   | Content       |
| `apps/ui/src/components/views/setup-view/steps/cli-setup-step.tsx`       | Yes         | Medium   | Content       |
| `apps/ui/src/components/views/setup-view/steps/providers-setup-step.tsx` | Yes         | Medium   | Content       |
| `apps/ui/src/store/app-store.ts`                                         | Yes         | **High** | Content       |
| `package-lock.json`                                                      | No          | Minimal  | Content       |

---

## Our Modifications at Risk

### 1. `apps/server/src/services/auto-mode-service.ts` (LOW RISK)

**Our changes**: 2 trivial `let` → `const` refactorings

```diff
-let revisionPrompt = ...
+const revisionPrompt = ...

-let braceStart = responseText.lastIndexOf('{', learningsIndex);
+const braceStart = responseText.lastIndexOf('{', learningsIndex);
```

**Resolution**: These style fixes are likely already in upstream or can be dropped safely.

### 2. `apps/ui/src/store/app-store.ts` (HIGH RISK)

**Our changes**:

- Added 3 keyboard shortcuts to `KeyboardShortcuts` interface
- Added `removeRunningTaskFromAllWorktrees` action

**Upstream changes**: Major refactoring - extracted types, defaults, and utils into separate files:

- `apps/ui/src/store/types/ui-types.ts` - Now contains `KeyboardShortcuts` interface
- `apps/ui/src/store/utils/shortcut-utils.ts` - Now contains `DEFAULT_KEYBOARD_SHORTCUTS`

**Resolution**: Our additions need to be migrated to the new modular structure:

1. Add to `apps/ui/src/store/types/ui-types.ts`:

```typescript
export interface KeyboardShortcuts {
  // ... existing ...
  agents: string; // ADD
  systems: string; // ADD
  knowledgeHub: string; // ADD
  // ... rest ...
}
```

2. Add to `apps/ui/src/store/utils/shortcut-utils.ts`:

```typescript
export const DEFAULT_KEYBOARD_SHORTCUTS: KeyboardShortcuts = {
  // ... existing ...
  agents: 'Shift+A', // ADD
  systems: 'Shift+Y', // ADD
  knowledgeHub: 'Shift+K', // ADD
  // ... rest ...
};
```

3. Add `removeRunningTaskFromAllWorktrees` to `app-store.ts` (interface + implementation)

---

## New Features Upstream (Recommended for Adoption)

| Feature                        | Commits                            | Impact | Recommendation                       |
| ------------------------------ | ---------------------------------- | ------ | ------------------------------------ |
| Store modularization           | `38e8a4c4`, `8caec151`, `f0042312` | High   | **Adopt** - improves maintainability |
| TypeScript error fixes (246)   | `5c335641`                         | High   | **Adopt** - code quality             |
| Electron main process refactor | `61582365`                         | Medium | **Adopt** - better architecture      |
| Ideation context settings      | `5a3dac15`                         | Medium | **Adopt** - useful feature           |
| Toast notifications for events | `4f1555f1`                         | Low    | Adopt                                |
| Project name in sidebar        | `b7c6b8bf`                         | Low    | Adopt                                |

---

## Bug Fixes (Recommended for Adoption)

| Fix                                         | Commit                             | Impact   |
| ------------------------------------------- | ---------------------------------- | -------- |
| Features stuck in in_progress after restart | `011ac404`                         | **High** |
| GitHub API rate limiting                    | `f5efa857`, `b5143f4b`, `8dd6ab21` | **High** |
| Project icon updates                        | `a60904bd`                         | Medium   |
| Plan mode system fixes                      | `cec5f91a`                         | Medium   |
| Spinner visibility                          | `98d98cc0`                         | Low      |
| macOS titleBarStyle                         | `99de7813`                         | Low      |

---

## Breaking Changes

None detected in this update.

---

## Resolution Strategy: Manual Resolution + Migration

Given HIGH severity with structural changes to core files:

### Step 1: Create Test Worktree

```bash
cd /Users/ruben/Documents/GitHub/automaker
MERGE_BRANCH="test/upstream-merge-20260127"
git worktree add ../automaker-upstream-test -b "$MERGE_BRANCH"
cd ../automaker-upstream-test
```

### Step 2: Install Dependencies

```bash
npm ci
npm run build:packages
```

### Step 3: Merge and Resolve

```bash
git merge upstream/v0.14.0rc
```

**Conflict resolution guide:**

| File                   | Resolution                                                                               |
| ---------------------- | ---------------------------------------------------------------------------------------- |
| `auto-mode-service.ts` | Accept upstream (our `let→const` is trivial)                                             |
| `app-store.ts`         | **Manual**: Keep upstream's modular imports, add our `removeRunningTaskFromAllWorktrees` |
| `eslint.config.mjs`    | Accept upstream                                                                          |
| `package-lock.json`    | Delete, run `npm install` to regenerate                                                  |
| Setup view files       | Accept upstream, verify our changes aren't lost                                          |
| `index.ts` (server)    | Review both sides, merge carefully                                                       |

### Step 4: Migrate Our Additions to New Structure

After merge, add our features to the new modular structure:

**File: `apps/ui/src/store/types/ui-types.ts`**

```typescript
// In KeyboardShortcuts interface, add after 'agent':
agents: string;
systems: string;
knowledgeHub: string;
```

**File: `apps/ui/src/store/utils/shortcut-utils.ts`**

```typescript
// In DEFAULT_KEYBOARD_SHORTCUTS, add after 'agent: "A"':
agents: 'Shift+A',
systems: 'Shift+Y',
knowledgeHub: 'Shift+K',
```

**File: `apps/ui/src/store/app-store.ts`**

```typescript
// Add to AppActions interface:
removeRunningTaskFromAllWorktrees: (taskId: string) => void;

// Add implementation:
removeRunningTaskFromAllWorktrees: (taskId) => {
  const current = get().autoModeByWorktree;
  const updated: typeof current = {};
  for (const key of Object.keys(current)) {
    const worktreeState = current[key];
    updated[key] = {
      ...worktreeState,
      runningTasks: worktreeState.runningTasks.filter((id) => id !== taskId),
    };
  }
  set({ autoModeByWorktree: updated });
},
```

### Step 5: Verification

```bash
npm run build:packages && npm run build:server
npm run test:server
npm run test:packages
```

### Step 6: Full App Test

```bash
TEST_PORT=4007 PORT=4008 \
VITE_SERVER_URL="http://localhost:4008" \
CORS_ORIGIN="http://localhost:4007" \
npm run dev:web
```

Verify:

- [ ] App loads at http://localhost:4007
- [ ] Agents page accessible (Shift+A)
- [ ] Systems page accessible (Shift+Y)
- [ ] Knowledge Hub accessible (Shift+K)
- [ ] No console errors

### Step 7: Merge to Main

```bash
cd /Users/ruben/Documents/GitHub/automaker
git checkout main
git merge test/upstream-merge-20260127
git push origin main
git worktree remove ../automaker-upstream-test
```

---

## Files Changed Summary

**248 files changed**, 11,744 insertions(+), 9,211 deletions(-)

Notable deletions:

- `graph-layout-bug.md` - Obsolete documentation removed
- `apps/ui/src/components/settings/model-defaults/phase-model-selector.tsx` - 1,582 lines removed (refactored)

---

## Recommendations

1. **Priority 1**: Merge `upstream/v0.14.0rc` using the Manual Resolution strategy above
2. **Priority 2**: Verify our SYSTEMS feature (Agents, Systems, Knowledge Hub) works after merge
3. **Priority 3**: Consider adopting the ideation context settings feature (`5a3dac15`)
4. **Priority 4**: Run full E2E test suite after merge

---

## Next Check

Schedule next upstream check in **3 days** (2026-01-30) per config.

---

_Generated by /upstream-check on 2026-01-27_
_Last checked commit: `900bbb5e`_
_New baseline: `cf35ca86` (v0.14.0rc)_
