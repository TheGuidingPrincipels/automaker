# Upstream Changes Report - 2026-01-21

## Summary

| Metric                | Value                  |
| --------------------- | ---------------------- |
| **Period**            | cf3ee6ae..a8ddd074     |
| **Last Checked**      | 2026-01-20             |
| **Upstream Branch**   | upstream/main          |
| **Total New Commits** | 194                    |
| **Analyzed Commits**  | ~100 (after filtering) |
| **Conflict Severity** | **MEDIUM-HIGH**        |
| **Upstream Release**  | v0.13.0                |

---

## Breaking Changes

### 1. Claude Compatible Providers System (PR #629)

**Commit:** a1f234c7

Major architectural change introducing a new provider profile system:

- New types: `ClaudeApiProfile`, `ClaudeCompatibleProvider`, `ProviderConfig`
- `buildEnv()` signature changed from `()` to `(providerConfig?, credentials?)`
- Added model mappings for z.AI, MiniMax, OpenRouter

**Impact on Fork:** HIGH - Our `AUTOMAKER_DISABLE_HOOK_TTS` env var modification conflicts with refactored `buildEnv()`

### 2. Unified API Key Profile System (PR #600)

**Commit:** d97c4b7b

Unified handling of Claude API keys across different providers with profile support.

---

## New Features (Recommended for Adoption)

| Feature                          | Commit   | Files Changed        | Recommendation                                |
| -------------------------------- | -------- | -------------------- | --------------------------------------------- |
| External terminal support        | a52c0461 | platform/terminal.ts | **Adopt** - Cross-platform terminal detection |
| Auto-discover ports              | 02a7a547 | server/index.ts      | **Adopt** - Useful for multi-instance         |
| Discard changes for worktrees    | b039b745 | routes/worktree      | **Adopt** - Enhances worktree UX              |
| Three viewing modes for spec     | c4652190 | spec-view/           | **Adopt** - Better spec editing               |
| Disable auth for local/trusted   | d266c98e | lib/auth.ts          | **Adopt** - Dev convenience                   |
| ANSI code stripping improvements | 17d42e79 | claude-usage-service | **Adopt** - Fixes parsing issues              |
| Settings migration from Electron | da80729f | multiple             | **Adopt** - Better data portability           |

---

## Bug Fixes (Relevant to Fork)

| Fix                                          | Commit   | Impact          |
| -------------------------------------------- | -------- | --------------- |
| Prevent new projects overriding global theme | 75fe579e | Medium          |
| CORS configuration for localhost             | b8875f71 | High (web mode) |
| WebSocket proxy in Vite dev server           | fdad82bf | High (dev mode) |
| Session token persistence for web mode       | a7f7898e | Medium          |
| Skip PR assignment for main worktree         | d6300f33 | Low             |

---

## Conflict Analysis

### Merge Simulation Result

- **Clean merge possible:** No
- **Conflicting files:** 3
- **Auto-merged files:** 14

### Conflicting Files

| File                                               | Watch Path? | Severity   | Conflict Type          |
| -------------------------------------------------- | ----------- | ---------- | ---------------------- |
| `apps/server/src/providers/claude-provider.ts`     | Yes         | **MEDIUM** | Same function modified |
| `apps/server/src/services/claude-usage-service.ts` | Yes         | **LOW**    | Adjacent sections      |
| `libs/types/src/index.ts`                          | Yes         | **LOW**    | Additive exports       |

---

## Investigation Findings

### Structural Analysis

#### claude-provider.ts (MEDIUM severity)

**Our changes:**

- Added `AUTOMAKER_DISABLE_HOOK_TTS` to `ALLOWED_ENV_VARS`
- Added default assignment in `buildEnv()`

**Upstream changes:**

- Major refactor of `buildEnv()` - now takes parameters `(providerConfig?, credentials?)`
- Added new type imports (`ClaudeApiProfile`, `ClaudeCompatibleProvider`)
- Expanded `ALLOWED_ENV_VARS` with 6+ new variables
- Added new constants and type guards

**Conflict location:** Lines 23-50 (ALLOWED_ENV_VARS) and lines 40-118 (buildEnv function)

**Resolution approach:** Integrate our `AUTOMAKER_DISABLE_HOOK_TTS` into BOTH code paths of upstream's refactored `buildEnv()`

---

#### claude-usage-service.ts (LOW severity)

**Our changes:**

- Added env filtering to exclude `ANTHROPIC_API_KEY` and `CLAUDE_CODE_OAUTH_TOKEN`
- Added `AUTOMAKER_DISABLE_HOOK_TTS` to spawn/PTY env

**Upstream changes:**

- Enhanced `stripAnsiCodes()` with OSC sequence handling
- Fixed percentage parsing (null vs 0 tracking)

**Conflict type:** Different code sections - no overlap

**Resolution approach:** Merge both sets of changes directly

---

#### libs/types/src/index.ts (LOW severity)

**Our changes (end of file):**

- CustomAgent type exports
- System type exports
- Knowledge Hub type exports

**Upstream changes (middle of file):**

- Model migration exports
- ClaudeCompatibleProvider exports
- Worktree/PR type exports
- Terminal type exports

**Conflict type:** Both additive, different locations

**Resolution approach:** Keep both sets of exports

---

### Integration Risk Assessment

| Component                 | Impact if Broken           | Blast Radius                 |
| ------------------------- | -------------------------- | ---------------------------- |
| `claude-provider.ts`      | CRITICAL - All AI features | Entire application           |
| `buildEnv()` function     | CRITICAL - Agent execution | All AI operations            |
| `claude-usage-service.ts` | LOW - Usage display only   | Settings page widget         |
| `libs/types/src/index.ts` | HIGH - Compile-time        | 56 files (28 server + 28 UI) |

### Test Coverage

| File                    | Coverage | Key Tests                                     |
| ----------------------- | -------- | --------------------------------------------- |
| claude-provider.ts      | Good     | 30+ tests covering executeQuery, env handling |
| claude-usage-service.ts | Good     | 35+ tests covering PTY execution, parsing     |
| Custom types            | None     | N/A (new files)                               |

---

## Resolution Strategy: Manual Resolution

**Overall Severity:** MEDIUM-HIGH

This merge requires manual intervention due to overlapping changes in watch paths, particularly the `buildEnv()` function refactor in claude-provider.ts.

### Step 1: Copy New Files from Upstream

```bash
# Files that must be added (referenced by upstream index.ts)
git checkout upstream/main -- libs/types/src/model-migration.ts
git checkout upstream/main -- libs/types/src/worktree.ts
git checkout upstream/main -- libs/types/src/terminal.ts
```

### Step 2: Merge libs/types/src/index.ts

Additive merge - keep both sets of exports:

1. Accept upstream's new exports in the middle of the file
2. Keep our SYSTEMS exports at the end

### Step 3: Merge claude-usage-service.ts

Independent sections - simple merge:

1. Keep our env filtering logic
2. Accept upstream's improved ANSI stripping

### Step 4: Merge claude-provider.ts (requires care)

Integration required:

1. Accept upstream's refactored `buildEnv(providerConfig?, credentials?)` signature
2. Add `AUTOMAKER_DISABLE_HOOK_TTS` to the expanded `ALLOWED_ENV_VARS` array
3. Add `AUTOMAKER_DISABLE_HOOK_TTS` default in BOTH code paths of new `buildEnv()`:
   - Provider-configured path (lines ~70-90)
   - Direct API path (lines ~95-115)

### Resolution Commands

```bash
# Start merge
git checkout main
git merge upstream/main

# Resolve conflicts manually in editor
# Then:
git add apps/server/src/providers/claude-provider.ts
git add apps/server/src/services/claude-usage-service.ts
git add libs/types/src/index.ts

git commit -m "merge: resolve upstream conflicts for v0.13.0"
```

### Verification Checklist

- [ ] `npm run build:packages` - Types compile
- [ ] `npm run build:server` - Server builds
- [ ] `npm run test:server -- tests/unit/providers/claude-provider.test.ts` - Provider tests pass
- [ ] `npm run test:server -- tests/unit/services/claude-usage-service.test.ts` - Usage service tests pass
- [ ] `npm run test:all` - Full test suite passes
- [ ] Manual: Start server and verify AI agent execution works
- [ ] Manual: Verify `/agents`, `/systems`, `/knowledge-hub` pages load

---

## Cherry-Pick Commands (Alternative: Selective Adoption)

If full merge is too risky, cherry-pick safe commits:

```bash
# External terminal support
git cherry-pick a52c0461

# Discard worktree changes
git cherry-pick b039b745

# Auto-discover ports
git cherry-pick 02a7a547

# ANSI stripping improvements (may conflict)
git cherry-pick 17d42e79

# Spec viewing modes
git cherry-pick c4652190
```

---

## Deferred for Later

These changes are bundled with the provider profile system and should be adopted together:

- Claude Compatible Providers System (a1f234c7)
- Unified API Key Profile System (d97c4b7b)
- Model migration utilities

Consider adopting in a dedicated branch after this merge stabilizes.

---

## Recommendations

1. **Create a test branch first:**

   ```bash
   git checkout -b test/upstream-merge
   git merge upstream/main
   ```

2. **Focus on minimal conflict resolution** - Don't refactor; just integrate changes

3. **Run full verification suite** before merging to main

4. **Consider splitting:** If conflicts are complex, cherry-pick safe features first, then tackle provider refactor separately

5. **Document your env var:** Add `AUTOMAKER_DISABLE_HOOK_TTS` to any relevant documentation in the merged code

---

## Files Modified in This Report

- Analyzed: 194 commits
- Conflict files: 3
- New upstream files to add: 3

---

_Generated by /upstream-check on 2026-01-21_
_Last checked commit: cf3ee6aec6589785116b2ec3329e1a2a0377dcfe_
_New baseline commit: a8ddd0744209a9ce09e34d55c39bc61f637d2888_
